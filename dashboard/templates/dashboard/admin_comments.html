{% extends 'base/base.html' %}
{% load static %}
{% load jalali_tags %}

{% block title %}
مدیریت دیدگاه‌ها
{% endblock %}

{% block links %}
<link rel="icon" href="{% static 'shops/icons/admin_comments.png' %}" type="image/png" />
<link rel="stylesheet" href="{% static 'dashboard/css/admin_comments.css' %}" />
{% endblock %}

{% block content %}
<div class="container py-5 text-end">

  <h1 class="mb-4 text-center fw-bold">💬 مدیریت دیدگاه‌ها</h1>

  <!-- فرم جستجو -->
  <form method="get" class="d-flex justify-content-center mb-4">
    <input type="text" name="date" class="form-control w-25 text-end" placeholder="جستجو بر اساس تاریخ (مثال: 1404/07/15)" value="{{ request.GET.date }}" />
    <input type="text" name="q" class="form-control w-50 text-end" placeholder="جستجو بر اساس نام کاربری ، شماره کاربر ، اسم کاربر یا نام ارایشگاه" value="{{ request.GET.q }}" />
    <button class="btn btn-primary ms-2">جستجو</button>
  </form>

  <!-- جدول دیدگاه‌ها -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>ردیف</th>
          <th>نام کاربری</th>
          <th>شماره کاربر</th>
          <th>اسم کاربر</th>
          <th>نام آرایشگاه</th>
          <th>متن دیدگاه</th>
          <th>تاریخ ارسال</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody>
        {% for comment in comments %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ comment.user.username }}</td>
          <td>{{ comment.user.phone_number }}</td>
          <td>{{ comment.user.get_full_name}}</td>
          <td>{{ comment.shop.name }}</td>
          <td class="text-start align-top">
            <div class="border rounded p-2 shadow-sm bg-light" style="max-width: 400px; overflow-wrap: break-word;">
              <p id="short-{{ comment.id }}" class="mb-1 text-muted small">
                {{ comment.content|truncatechars:100 }}
              </p>
          
              {% if comment.content|length > 100 %}
                <p id="full-{{ comment.id }}" class="mb-1 text-muted small d-none">
                  {{ comment.content }}
                </p>
                <a href="#" class="text-primary small" onclick="toggleComment(this, {{ comment.id }}); return false;">
                  نمایش بیشتر
                </a>
              {% endif %}
            </div>
          </td>
          <td>{{ comment.created_at|to_jalali:'%Y/%m/%d - %H:%M' }}</td>
          <td>
            <a
              href="{% url 'dashboard:delete_comment_url' comment.id %}"
              class="btn btn-sm btn-danger"
              onclick="return confirm('آیا از حذف این دیدگاه مطمئنی؟')"
            >
              حذف
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-muted py-4">
            هیچ دیدگاهی یافت نشد 😕
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- صفحه‌بندی -->
  <div class="d-flex flex-column align-items-center mt-4">
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if comments.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1&q={{ query }}&date={{ request.GET.date }}">⏭ اول</a>
        </li>
        <li class="page-item">
          <a
            class="page-link"
            href="?page={{ comments.previous_page_number }}&q={{ query }}&date={{ request.GET.date }}"
            >قبلی</a
          >
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">⏭ اول</span></li>
        <li class="page-item disabled"><span class="page-link">قبلی</span></li>
        {% endif %}

        <li class="page-item active">
          <span class="page-link"
            >صفحه {{ comments.number }} از {{ comments.paginator.num_pages }}</span
          >
        </li>

        {% if comments.has_next %}
        <li class="page-item">
          <a
            class="page-link"
            href="?page={{ comments.next_page_number }}&q={{ query }}&date={{ request.GET.date }}"
            >بعدی</a
          >
        </li>
        <li class="page-item">
          <a
            class="page-link"
            href="?page={{ comments.paginator.num_pages }}&q={{ query }}&date={{ request.GET.date }}"
            >آخر ⏮</a
          >
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">بعدی</span></li>
        <li class="page-item disabled"><span class="page-link">آخر ⏮</span></li>
        {% endif %}
      </ul>
    </nav>

    <!-- پرش به صفحه -->
    <form method="get" class="d-flex align-items-center mt-3">
      <input type="hidden" name="q" value="{{ query }}" />
      <input type="hidden" name="date" value="{{ request.GET.date }}" />
      <label for="page" class="me-2">برو به صفحه:</label>
      <input
        type="number"
        name="page"
        min="1"
        max="{{ comments.paginator.num_pages }}"
        class="form-control form-control-sm text-center me-2"
        style="width: 80px;"
      />
      <button class="btn btn-sm btn-outline-primary" type="submit">برو</button>
    </form>
  </div>

  <div class="text-center mt-4">
    <a href="{% url 'dashboard:admin_dashboard_url' %}" class="btn btn-secondary">بازگشت به پنل مدیریت</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'dashboard/js/admin_comments.js' %}"></script>
{% endblock scripts %}